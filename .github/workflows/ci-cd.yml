# SGICS - Workflow de CI/CD para GitHub Actions
# Automatiza testing, anÃ¡lisis de cÃ³digo y deployment

name: SGICS CI/CD Pipeline

# Triggers - cuÃ¡ndo se ejecuta el workflow
on:
  # En cada push a ramas principales y features
  push:
    branches: 
      - main              # ProducciÃ³n
      - develop          # Desarrollo
      - 'SCRUM-*'        # Branches de features del proyecto
      - 'feature/*'      # Features adicionales
      - 'hotfix/*'       # Hotfixes de emergencia
  # En cada pull request a main o develop
  pull_request:
    branches: [ main, develop ]
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

# Variables de entorno globales
env:
  PYTHON_VERSION: "3.12"  # Python 3.14 aÃºn no soportado por Django
  NODE_VERSION: "18"
  
jobs:
  # ==========================================
  # JOB 1: TESTS BACKEND (Django + pytest)
  # ==========================================
  backend-tests:
    name: "Backend Tests (Python ${{ env.PYTHON_VERSION }})"
    runs-on: ubuntu-latest
    
    # Servicios necesarios para los tests
    services:
      # Base de datos MySQL para tests
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: test_sgics
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass
          MYSQL_ROOT_PASSWORD: test_root_pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      # Redis para tests de cache
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
    
    steps:
    # Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    # Configurar Python con cachÃ© de pip
    - name: ğŸ Configurar Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'backend/requirements.txt'
    
    # Instalar dependencias del backend
    - name: ğŸ“¦ Instalar dependencias Backend
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage pytest-cov
    
    # Ejecutar migraciones para tests
    - name: ğŸ—ƒï¸ Preparar base de datos de prueba
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://test_user:test_pass@localhost:3306/test_sgics
        DJANGO_SETTINGS_MODULE: scouts_platform.settings.test
      run: |
        python manage.py migrate --noinput
    
    # Ejecutar tests con coverage
    - name: ğŸ§ª Ejecutar tests Backend (pytest)
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://test_user:test_pass@localhost:3306/test_sgics
        DJANGO_SETTINGS_MODULE: scouts_platform.settings.test
      run: |
        coverage run -m pytest -v --tb=short
        coverage xml
        coverage report
    
    # Subir coverage como artifact
    - name: ğŸ“Š Subir coverage Backend
      uses: actions/upload-artifact@v3
      with:
        name: backend-coverage
        path: backend/coverage.xml
    
    # Health check despuÃ©s de iniciar servidor
    - name: ğŸ©º Verificar health endpoints
      working-directory: ./backend
      env:
        DATABASE_URL: mysql://test_user:test_pass@localhost:3306/test_sgics
        DJANGO_SETTINGS_MODULE: scouts_platform.settings.test
      run: |
        # Iniciar servidor en background
        python manage.py runserver 8000 &
        SERVER_PID=$!
        
        # Esperar que el servidor inicie
        sleep 10
        
        # Verificar endpoints de salud
        echo "ğŸ” Verificando /healthz/"
        curl -f http://localhost:8000/healthz/ || exit 1
        
        echo "ğŸ” Verificando /healthz/ready/"
        curl -f http://localhost:8000/healthz/ready/ || exit 1
        
        echo "âœ… Health checks exitosos"
        
        # Terminar servidor
        kill $SERVER_PID

  # ==========================================
  # JOB 2: TESTS FRONTEND (Vue + Vitest)
  # ==========================================
  frontend-tests:
    name: "Frontend Tests (Node ${{ env.NODE_VERSION }})"
    runs-on: ubuntu-latest
    
    steps:
    # Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    # Configurar Node.js con cachÃ© de npm
    - name: ğŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    # Instalar dependencias del frontend
    - name: ğŸ“¦ Instalar dependencias Frontend
      working-directory: ./frontend
      run: |
        npm ci --prefer-offline --no-audit
    
    # Ejecutar tests del frontend
    - name: ğŸ§ª Ejecutar tests Frontend (Vitest)
      working-directory: ./frontend
      run: |
        npm run test:coverage
    
    # Subir coverage como artifact
    - name: ğŸ“Š Subir coverage Frontend
      uses: actions/upload-artifact@v3
      with:
        name: frontend-coverage
        path: frontend/coverage/
    
    # Build para verificar que compila
    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: |
        npm run build

  # ==========================================
  # JOB 3: ANÃLISIS DE CÃ“DIGO (SonarQube)
  # ==========================================
  sonar-analysis:
    name: "AnÃ¡lisis SonarQube"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.event_name != 'pull_request' && vars.SONAR_TOKEN != ''
    
    steps:
    # Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarQube
    
    # Descargar artifacts de coverage
    - name: ğŸ“¥ Descargar coverage Backend
      uses: actions/download-artifact@v3
      with:
        name: backend-coverage
        path: backend/
    
    - name: ğŸ“¥ Descargar coverage Frontend  
      uses: actions/download-artifact@v3
      with:
        name: frontend-coverage
        path: frontend/coverage/
    
    # Ejecutar anÃ¡lisis SonarQube
    - name: ğŸ” AnÃ¡lisis SonarQube
      uses: sonarqube-quality-gate-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================
  # JOB 4: DEPLOYMENT CONDICIONAL POR RAMA
  # ==========================================
  deploy-production:
    name: "Deploy a ProducciÃ³n"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    # Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    # TODO: El equipo de DevOps debe completar el deployment
    # Ejemplos de deployment:
    
    # OpciÃ³n 1: Deploy via SSH/SCP
    - name: ğŸš€ Deploy via SSH
      run: |
        echo "TODO: Configurar deployment al hosting"
        echo "Usar credenciales desde secrets del repositorio"
        # scp -r . user@hosting-server.com:/path/to/app/
    
    # OpciÃ³n 2: Deploy via FTP
    - name: ğŸš€ Deploy via FTP
      run: |
        echo "TODO: Usar FTP para subir archivos al hosting"
        # lftp ftp://hosting-server.com -u ${{ secrets.FTP_USER }}
    
    # Verificar deployment con health checks
    - name: ğŸ©º Verificar deployment exitoso
      run: |
        echo "TODO: Verificar que la aplicaciÃ³n desplegada responda"
        # curl -f https://tu-dominio.com/healthz/
        # curl -f https://tu-dominio.com/healthz/ready/

  # Deploy a entorno de desarrollo (rama develop)
  deploy-development:
    name: "Deploy a Desarrollo"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy a desarrollo
      run: |
        echo "TODO: Configurar deployment al entorno de desarrollo"
        echo "URL de desarrollo: https://dev-sgics.tu-dominio.com"
        # Deployment especÃ­fico para desarrollo
    
    - name: ğŸ©º Verificar deployment desarrollo
      run: |
        echo "TODO: Health check del entorno de desarrollo"
        # curl -f https://dev-sgics.tu-dominio.com/healthz/

  # Deploy de features para testing (ramas SCRUM-*)
  deploy-feature:
    name: "Deploy Feature para Testing"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: startsWith(github.ref, 'refs/heads/SCRUM-') && github.event_name == 'push'
    environment: feature-testing
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Extraer nombre de la rama
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "FEATURE_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
        echo "Deployando feature: $BRANCH_NAME"
    
    - name: ğŸš€ Deploy feature branch
      run: |
        echo "TODO: Configurar deployment de feature para testing"
        echo "Feature URL: https://${{ env.FEATURE_NAME }}-sgics.tu-dominio.com"
        # Deployment especÃ­fico para features
        
    - name: ğŸ©º Verificar deployment feature
      run: |
        echo "TODO: Health check del feature deployment"
        # curl -f https://${{ env.FEATURE_NAME }}-sgics.tu-dominio.com/healthz/

  # ==========================================
  # JOB 5: NOTIFICACIONES
  # ==========================================
  notify:
    name: "Notificar Resultado del Pipeline"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: always()
    
    steps:
    - name: ğŸ“§ Notificar resultado de tests
      run: |
        if [ "${{ needs.backend-tests.result }}" = "success" ] && [ "${{ needs.frontend-tests.result }}" = "success" ]; then
          echo "âœ… Tests completados exitosamente en rama: ${{ github.ref_name }}"
          # TODO: Enviar notificaciÃ³n de Ã©xito (Slack, Discord, email, etc.)
        else
          echo "âŒ Tests fallaron en rama: ${{ github.ref_name }}"
          echo "Backend result: ${{ needs.backend-tests.result }}"
          echo "Frontend result: ${{ needs.frontend-tests.result }}"
          # TODO: Enviar notificaciÃ³n de fallo con detalles
        fi
    
    # NotificaciÃ³n especÃ­fica para deployment
    - name: ğŸ“§ Notificar deployment (si aplica)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/SCRUM-'))
      run: |
        echo "ğŸš€ Deployment iniciado para rama: ${{ github.ref_name }}"
        # TODO: Notificar inicio de deployment
        
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ğŸ“ˆ Deployment a PRODUCCIÃ“N"
          # TODO: NotificaciÃ³n especial para producciÃ³n
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          echo "ğŸ§ª Deployment a DESARROLLO"
          # TODO: NotificaciÃ³n para desarrollo
        else
          echo "ğŸ”§ Deployment de FEATURE para testing"
          # TODO: NotificaciÃ³n para features
        fi